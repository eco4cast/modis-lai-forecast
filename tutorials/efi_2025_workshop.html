<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John Smith, Will Hammond, Chris Jones, David Durden">
<meta name="dcterms.date" content="2025-04-17">

<title>EFI_2025_Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="efi_2025_workshop_files/libs/clipboard/clipboard.min.js"></script>
<script src="efi_2025_workshop_files/libs/quarto-html/quarto.js"></script>
<script src="efi_2025_workshop_files/libs/quarto-html/popper.min.js"></script>
<script src="efi_2025_workshop_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="efi_2025_workshop_files/libs/quarto-html/anchor.min.js"></script>
<link href="efi_2025_workshop_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="efi_2025_workshop_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="efi_2025_workshop_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="efi_2025_workshop_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="efi_2025_workshop_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">EFI_2025_Workshop</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John Smith, Will Hammond, Chris Jones, David Durden </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 17, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="about-this-tutorial" class="level1">
<h1>1 About this tutorial</h1>
<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">1.1 Learning objectives</h2>
<!-- -   Overview of the [Post Fire Recovery - MODIS LAI](https://projects.ecoforecast.org/neon4cast-docs/) -->
<!--     theme for the [NEON Ecological Forecast Challenge](https://projects.ecoforecast.org/neon4cast-ci/) -->
<ul>
<li>How to download the necessary data from Planetary Computer</li>
<li>How to create a simple forecast for the Post Fire Recovery theme</li>
<li>How to submit/score a forecast to evaluate its accuracy</li>
</ul>
</section>
<section id="target-user-groups-for-this-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="target-user-groups-for-this-tutorial">1.2 Target user groups for this tutorial</h2>
<p>This tutorial is intended to be used by ecological forecasters at any stage of expertise and may be used as a learning tool as an introduction to forecasting properties of ecological processes spatially and temporally. Below, we provide code for introductory examples to walk through the entire process of creating and submitting a forecast to the Ecological Forecasting challenge. This includes:</p>
<ol type="1">
<li>Accessing target datasets of MODIS LAI.</li>
<li>Accessing climate forecast data to use as drivers in models predicting LAI recovery post fire.</li>
<li>How to create models for raster data.</li>
<li>How to submit a forecast to the forecast challenge</li>
</ol>
<p>Upon completing this tutorial, participants should be able to create and submit forecasts to the MODIS LAI Post Fire Recovery theme of the EFI RCN NEON Ecological Forecasting challenge.</p>
</section>
<section id="things-you-will-need-to-complete-this-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="things-you-will-need-to-complete-this-tutorial">1.3 Things you will need to complete this tutorial</h2>
<p>You will need a current version of R (v4.4 or newer) to complete this tutorial. We also recommend the RStudio IDE to work with R.</p>
<p>To complete the workshop via this markdown document the following packages will need to be installed:</p>
<ul>
<li><code>tidyverse</code></li>
<li><code>lubridate</code></li>
<li><code>tsibble</code></li>
<li><code>stars</code></li>
<li><code>gdalcubes</code></li>
<li><code>rstac</code></li>
<li><code>terra</code></li>
<li><code>scoringRules</code></li>
<li><code>forecast</code></li>
<li><code>nimble</code></li>
<li><code>spatstat.sparse</code></li>
<li><code>assertthat</code></li>
<li><code>minioclient</code></li>
<li><code>purrr</code></li>
<li><code>neonstore</code></li>
<li><code>imputeTS</code></li>
<li><code>remotes</code> (to install neon4cast from gitHub)</li>
<li><code>neon4cast</code> (from github)</li>
</ul>
<p>The following code chunk should be run to install packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'tidyverse'</span>) <span class="co"># collection of R packages for data manipulation, analysis, and visualisation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'lubridate'</span>) <span class="co"># working with dates and times</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'stars'</span>) </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'gdalcubes'</span>) </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'rstac'</span>) </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'terra'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'scoringRules'</span>) <span class="co"># package to score forecasts</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'forecas'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'nimble'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'spatstat.sparse'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'assertthat'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'minioclient'</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'purrr'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'remotes'</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'neonstore'</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'imputeTS'</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">'eco4cast/neon4cast'</span>) <span class="co"># package from NEON4cast challenge organisers to assist with forecast building and submission</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"eco4cast/score4cast"</span>) <span class="co"># package to score forecasts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then load the packages.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>version<span class="sc">$</span>version.string</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>## [1] "R version 4.3.1 (2023-06-16 ucrt)"</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibble)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstac)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scoringRules)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat.sparse)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(assertthat)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(minioclient)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(remotes)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(neon4cast)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(minioclient)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(neonstore)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imputeTS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="introduction" class="level1">
<h1>2 Introduction</h1>
<section id="the-neon-ecological-forecast-challenge" class="level2">
<h2 class="anchored" data-anchor-id="the-neon-ecological-forecast-challenge">2.1 <a href="https://projects.ecoforecast.org/neon4cast-ci/">The NEON Ecological Forecast Challenge</a></h2>
<p>The Challenge has been organized by the Ecological Forecasting Initiative Research Coordination Network (<a href="https://ecoforecast.org/">EFI RCN</a>). The EFI-NEON Forecasting Challenges are the first to set up a system to continually compile and score community generated forecasts for true out of sample data prior to data collection. These forecast challenges are extremely helpful for understanding how long into the future we can predict certain ecological properties and what types of models perform best. Questions about ecosystems and ecosystem services are inherently focused on the future because they involve understanding how natural systems will respond to changing environmental, social, and economic conditions over time. Commonly ecosystems are analyzed as single longitudinal time series. However, the intrinsic biodiversity within ecosystems leads to spatial gradients with varying ecosystem services. In this workshop, we present our prototype of a spatio-temporal forecasting challenge. This project represents a novel direction for the EFI-RCN and the field of ecological forecasting as a whole, by moving from single-site temporal forecast models to the consideration of entire eco-regions in a spatio-temporal setting.</p>
<p>The current NEON-EFI forecasting challenge has participants produce forecasts of future observations that are collected and published by NEON. The temporal forecasting challenge currently has a number of different themes that encompass aquatic systems, terrestrial systems, their respective eco-processes, and population ecology (e.g.&nbsp;ticks and beetles). In the long term, we envision partnering with the ecological forecasting community to incorporate spatio-temporal processes that are representative of the existing themes in the NEON-EFI forecasting challenge.</p>
<p>While we believe that it is crucial to incorporate spatial components into existing temporal forecasting models, there are challenges to address including the evaluation of spatially misaligned forecasts, increased model complexity and computation time, and the need to archive metadata for spatio-temporal ensemble forecasts. There are also natural research questions that scaffold from all of the previous research done in the context of the EFI-NEON forecasting challenge: are the same modeling frameworks that we deemed successful in this forecasting challenge well-suited to the addition of a spatial component? Are these models still successful but difficult to scale, computationally? Does the additional of granular spatial covariates help us to improve predictive performance of the model over it’s temporal counterpart? All of these questions are wide open but we need <strong>you</strong>, the Ecological Forecasting community, to help!</p>
<p>Our challenge is open to anyone who would like to participate, and in order for us to continue to grow this challenge we need feedback from this community. We will provide a tutorial on how to submit forecasts to the spatial forecasting challenge, and hope that this helps to facilitate usage and growth of the infrastructure that we have developed.</p>
</section>
<section id="goals-for-forecasts-of-post-fire-recovery" class="level2">
<h2 class="anchored" data-anchor-id="goals-for-forecasts-of-post-fire-recovery">2.2 Goals for forecasts of post fire recovery</h2>
<p>Ecologist are interested in tracking how landscapes and ecosystems <strong>recover from disturbances such as fire</strong> (changes in leaf area index (LAI)). The timing and pace of recovery can depend on many factors such as fire severity, ecosystem type, weather, species present in the location, and species present around the location. For this challenge we are forecasting MODIS LAI averaged across the month to account for cloud cover and other factors. The MODIS LAI product is 500 m spatial resolution and as such LAI values for each pixel are the combination of the combined foliage of all individuals and species in that 500 m pixel. Each fire that is being forecast has multiple pixels that need to be forecast, so there are multiple scores for each fire for each time step.</p>
<p>The speed and trajectory of post fire recovery varies for many reasons and it is important to understand the drivers of post fire recovery in LAI. By knowing how different ecosystem recovery post-fire over time we can forecast recovery in LAI for different ecosystems post fire. These forecasts could be used to help determine management of various ecosystems under future climates.</p>
<p>There are many open questions that this challenge could help us address: - What models perform the best for predicting LAI recovery post fire? and do they change by ecosystem type? - What are the key drivers for post fire recovery and do they change across ecosystem types or fire severity? - Are areas within each fire more predictable than others? If so why?</p>
<p>There are many more open questions and we will have a survey at the end to gather the ones that everyone is interested in and to help us guide the challenge.</p>
</section>
<section id="overview-of-the-modis-lai-post-fire-recovery-theme" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-modis-lai-post-fire-recovery-theme">2.3 Overview of the <a href="https://projects.ecoforecast.org/neon4cast-docs/">MODIS LAI Post Fire Recovery</a> theme</h2>
<p><strong>What</strong>: Forecast Leaf Area Index (LAI) recovery post fire based on MODIS LAI. More information on the MODIS LAI data product (MOD15A2H.061: Terra Leaf Area Index/FPAR 8-Day Global 500m) we are forecasting can be found <a href="https://lpdaac.usgs.gov/products/myd15a2hv061/">here</a> or <a href="https://planetarycomputer.microsoft.com/dataset/modis-15A2H-061#overview">here</a>. Note: We are not downloading the target datasets from the Planetary computer but are downloading a version that has had images with cloud cover greater than 10% removed and then the MODIS LAI values averaged for the each month instead of the 8 days of the MODIS LAI product.</p>
<ul>
<li><code>LAI</code>: Leaf Area Index in each cell within the fire bounding box.</li>
</ul>
<p><strong>Where</strong>: Before we can forecast fire recovery, we first need to define the fires of interest and their spatial extents. We have initially selected a handful of fires that span ecosystem types, occurred in close proximity to NEON sites to provide additional data sources for modeling efforts, occurred relatively recently, and were relatively large fires as the MODIS LAI data is being used currently at a relatively course resolution. We currently have shape files defined for 5 fires with 3 occurring in close proximity to NEON sites, the fire names in the spatial forecast system are:</p>
<ul>
<li>august_complex = California August Complex fire started in August 2020 and burned a total of 1,032,648 acres (417,898 ha) in NW California.</li>
<li>east_troublesome = Colorado East Troublesome fire burned 193,812 acres in October and November 2020.</li>
<li>sawmill = The Sawmill Fire that burned 46,991 acres (190 km^2) in the U.S. state of Arizona in April 2017 and was close in proximity Santa Rita Experimental Range (<a href="https://www.neonscience.org/field-sites/srer">NEON SRER</a>)</li>
<li>creek = Soaproot Saddle (<a href="https://www.neonscience.org/field-sites/soap">NEON SOAP</a>)</li>
<li>chimney_tops = The Chimney Tops 2 fire occured in November 2016 in and around Great Smoky Mountain National Park (<a href="https://www.neonscience.org/field-sites/grsm">NEON GRSM</a>)</li>
</ul>
<p><strong>When</strong>: Target data are available as early as 2010 across our selected fires for monthly averages in LAI for each cell for each fire. Forecasts are accepted up to 1 month ahead on a monthly time step.</p>
</section>
</section>
<section id="forecasting-modis-lai-recovery-post-fire" class="level1">
<h1>3 Forecasting MODIS LAI Recovery Post Fire</h1>
<section id="define-spatial-and-temporal-parameters-for-our-forecast" class="level2">
<h2 class="anchored" data-anchor-id="define-spatial-and-temporal-parameters-for-our-forecast">3.1 Define spatial and temporal parameters for our forecast</h2>
<p>The target areas for the fires of interest are available in the <code>/shp</code> directory in Github repository. The <code>fire_box</code> function is available to grab the target area for each fire. The <code>pad_box</code> argument will pad a 0.5 degrees on each side on each side of the bounding box as defined by the fire mask shapefiles. Below is an example for the <code>august_complex</code> fire.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fire_box <span class="ot">&lt;-</span> <span class="fu">fire_bbox</span>(<span class="at">fire =</span> <span class="st">"august_complex"</span>, <span class="at">pad_box =</span> <span class="cn">TRUE</span>, <span class="at">dir =</span> <span class="st">'../shp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-in-the-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-the-data">3.2 Read in the data</h2>
<p>To facilitate spatio-temporal forecasting at the sites of interest for this challenge, time series data of 500m LAI measurements are stored in a MinIO bucket. MinIO is high-performance software-defined S3 compatible object storage. To read and write to the forecast cloud, we use functions with the prefix “spat4cast_”. We can use <code>spat4cast_get_data()</code> to read in a RasterCube object with the provided time series of LAI measurements, and <code>spat4cast_get_target()</code> to read in a target for our forecast.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>raster_cube <span class="ot">&lt;-</span> <span class="fu">spat4cast_get_data</span>(<span class="at">start_date =</span> <span class="st">"2002-01-01"</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">end_date =</span> <span class="st">"2025-05-01"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">fire =</span> <span class="st">"august_complex"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">collection =</span> <span class="st">"modis-15A2H-061"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">asset_name =</span> <span class="st">"Lai_500m"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">srs =</span> <span class="st">"EPSG:4326"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dx =</span> <span class="fl">0.1</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dy =</span> <span class="fl">0.1</span>, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dt =</span> <span class="st">"P30D"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">aggregation =</span> <span class="st">"mean"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">resampling =</span> <span class="st">"near"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">variable =</span> <span class="st">"lai_recovery"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dir.create("files"): 'files' already exists</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>target_dir <span class="ot">&lt;-</span> <span class="fu">spat4cast_get_target</span>(<span class="at">date =</span> <span class="st">"2025-04-01"</span>, <span class="at">fire =</span> <span class="st">"august_complex"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dir.create("target"): 'target' already exists</code></pre>
</div>
</div>
</section>
<section id="visualise-the-target-data" class="level2">
<h2 class="anchored" data-anchor-id="visualise-the-target-data">3.3 Visualise the target data</h2>
<p>The target data are also stored in MinIO bucket. The target files are generated on a monthly basis via github actions using <code>targets/spatial_targets.R</code> workflow. The files can be downloaded with the <code>spat4cast_get_targets</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tg <span class="ot">&lt;-</span> <span class="fu">rast</span>(target_dir)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="efi_2025_workshop_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="create-the-training-dataset" class="level2">
<h2 class="anchored" data-anchor-id="create-the-training-dataset">3.4 Create the training dataset</h2>
<p>For some modelling approaches, a gdalcubes “RasterCube” format may be appropriate (e.g.&nbsp;ensemble climatology). For other modelling approaches though, it may be more straightforward to use the spatial time series data as a matrix or array. The <code>gdalcube_to_matrix2</code> function will transform a RasterCUbe object into a matrix, where rows correspond to time slices, and columns correspond to gridcells. The threshold argument sets a limit at which high measurements are set to NA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data_matrix <span class="ot">&lt;-</span> <span class="fu">gdalcube_to_matrix2</span>(raster_cube, <span class="at">threshold =</span> <span class="dv">12</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-forecasts-some-simple-models" class="level2">
<h2 class="anchored" data-anchor-id="example-forecasts-some-simple-models">3.5 Example forecasts: some simple models</h2>
<p>The main branch currently has two baseline models implemented. These models are intended to provide a benchmark for evaluating the performance of more complex models. The two baseline models that are currently implemented are:</p>
<ul>
<li>A spatial climatology ensemble model</li>
<li>A grid ARIMA parametric model</li>
</ul>
<p>We also have two baseline models in the development and debugging stage: - A spatio-temporal ICAR random walk - A spatio-temporal Gaussian Process.</p>
<p>For now, the first two models that we have implemented will provide reasonable competitors to the models developed by challenge participants, and in the context of this workshop will provide a nice demonstration of the difference between parametric and ensemble models and how they are scored.</p>
<section id="forecast-modis-lai-post-fire-local-climatology-model" class="level3">
<h3 class="anchored" data-anchor-id="forecast-modis-lai-post-fire-local-climatology-model">3.5.1 Forecast MODIS LAI post fire: Local Climatology Model</h3>
<p>The first baseline model is a <em>local climatology</em> model. Not to be confused with a climate model (which many participants may be familiar with), the purpose of a climatology model is to use historical data to build a forecast distribution.</p>
<p>The <em>local</em> part of the climatology model comes into play when we consider exactly what historical data is used to create the forecast distribution. As an example, suppose that we have ten years of daily temperature data for the entire state of Virginia. If our end goal is to create a forecast distribution for the temperature in Blacksburg, we may only want to consider the historical data from Montgomery County instead of the entire state. Indeed, the term <em>local</em> refers to the fact that we are only considering points that are, in some broad sense, close to our target in space or time.</p>
<p>In the context of generating baseline forecasts for post-fire LAI recovery, we have data from MODIS dating back to 2002 that comes in roughly every 8 days. Rather than using the entire dataset, we consider only LAI measurements that occur in the month of interest. This gives us a snapshot of historical data within a given month so that we can build an informed forecast distribution for how we would expect our process to behave. For example, if we are interested in forecasting the LAI at the Soaproot Saddle NEON site for May 2025, the local climatology model will include LAI measurements from May 2002, May 2003, etc all the way until May 2024.</p>
<p>A natural follow-up question: once we have identified the data, we want a baseline model. So what exactly is the statistical model that we are using here?</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="efi_2025_workshop_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In fact these singleton data points <em>are</em> our statistical model, at least after a little bit of work. We put some little densities around them (sometimes called “kernel dressing” in the literature) and these little densities come together to turn these singleton points into a forecast distribution. Taking our example from above, this process yields the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(dat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="efi_2025_workshop_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>By choosing to “fit” a non-parametric model to our data we get some additional flexibility, since we don’t have to conform to some particular pre-specified probability distribution. For example, if we were to just take a mean and standard deviation of the above data and treat it as a univariate Normal distribution we would be missing out on the fact that our data is actually bimodal with two areas of high density.</p>
<p>In many situations, the climatology or local climatology models perform surprisingly well. To paraphrase Benjamin Franklin: “death, taxes, and losing to the climatology”. Post fire LAI recovery presents an interesting challenge for historical climatology data however: sites that not previously had a fire during the MODIS period from 2002 to present may not adequately capture the behavior of LAI during post fire-recovery.</p>
<p>Now, for the interesting part, a demonstration of how to fit the climatology model! The function <code>spat_climatology()</code> builds a climatology forecast using historical data for a given month, and stores an ensemble of <code>geotiff</code> files. In the event that there are missing historical data for a given month, missing values are imputed using a simple bootstrap re-sample of previous values within a pixel (using the internal <code>na_bootstrap()</code> function). For cyberinfrastructure pipeline purposes, <code>spat_climatology</code> returns the directory that ensemble forecasts were written to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fire_box <span class="ot">&lt;-</span> <span class="fu">fire_bbox</span>(<span class="at">fire =</span> <span class="st">"august_complex"</span>, <span class="at">pad_box =</span> <span class="cn">TRUE</span>, <span class="at">dir =</span> <span class="st">'../shp'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingest data ------------------------------------------------------------</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>gdalcubes<span class="sc">::</span><span class="fu">gdalcubes_options</span>(<span class="at">parallel=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use ingest_planetary_data function to extract raster cube for fire bounding box between Jan 1 2002 and July 1 2023.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>raster_cube <span class="ot">&lt;-</span> <span class="fu">ingest_planetary_data</span>(<span class="at">start_date =</span> <span class="st">"2015-01-01"</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">end_date =</span> <span class="st">"2025-03-01"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">box =</span> fire_box<span class="sc">$</span>bbox,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">srs =</span> <span class="st">"EPSG:4326"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dx =</span> <span class="fl">0.1</span>, </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dy =</span> <span class="fl">0.1</span>, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">dt =</span> <span class="st">"P30D"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">collection =</span> <span class="st">"modis-15A2H-061"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">asset_name =</span> <span class="st">"Lai_500m"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast ----------------------------------------------------------------</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(minioclient)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ensemble_forecast_dir <span class="ot">&lt;-</span> <span class="fu">spat_climatology</span>(<span class="at">cuberast =</span> raster_cube,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">date =</span> <span class="st">'2025-03-01'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">dir =</span> <span class="st">'climatology'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="forecast-modis-lai-post-fire-gridded-arima-model" class="level3">
<h3 class="anchored" data-anchor-id="forecast-modis-lai-post-fire-gridded-arima-model">3.5.2 Forecast MODIS LAI post fire: gridded ARIMA model</h3>
<p>The Grid ARIMA baseline model takes each grid cell in the fire polygon and fits a Seasonal Autoregressive Integrated Moving Average (SARIMA) model. This is a classical technique from time series analysis that combines differencing with autoregressive and moving average models.</p>
<p>If we are in the business of providing technical definitions: a time series <span class="math inline">\(x = \{x_1, ..., x_T \}\)</span> follows a <strong>SARIMA(p, d, q)(P, D, Q)</strong><span class="math inline">\(_s\)</span> process if it can be written in the form: <span class="math display">\[\begin{align*}
\phi_P (B^s) \Phi_p (B) (1 - B^s)^D (1 - B)^d x_t = \theta_q (B^s) \Theta_q (B) w_t
\end{align*}\]</span> For our purposes, though, we just need to think of the SARIMA model as a flexible time series technique that lets us capture the temporal autocorrelation, seasonal effects, and correlated errors within a grid cell in a statistically cohesive manner.</p>
<p>There are a number of quantities that require estimation within each grid cell. The actual specification of each <span class="math inline">\(p_{i,j}, q_{i,j}, d_{i,j}\)</span> as well as estimates of their associated parameters <span class="math inline">\(\vec{\theta}_{i,j}, \vec{\phi}_{i,j}, \sigma^2_{i,j}\)</span> are computed using the <code>auto.arima()</code> function in the <code>forecast</code> library. We do this by taking the time series of LAI data within a particular grid cell, log transforming it, and letting <code>auto.arima()</code> pick the best model. We then generate forecasts for the next time point(s) using <code>S3</code> method for the <code>forecast</code> function and extract the mean and standard deviation.</p>
<p>We fit our grid cell SARIMA baseline model using the <code>spat_arima_grid()</code> function. <code>spat_arima_grid</code> takes a rastercube object as input and fits a SARIMA model using <code>auto.arima</code> to each grid cell. Grid cells with less than 25 available data points are not considered. As with <code>spat_climatology</code>, the <code>spat_arima_grid</code> function returns the directory that forecasts were written to for pipeline purposes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>raster_cube <span class="ot">&lt;-</span> <span class="fu">spat4cast_get_data</span>(<span class="at">start_date =</span> <span class="st">"2002-01-01"</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">end_date =</span> <span class="st">"2025-05-01"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">fire =</span> <span class="st">"august_complex"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">collection =</span> <span class="st">"modis-15A2H-061"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">asset_name =</span> <span class="st">"Lai_500m"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">srs =</span> <span class="st">"EPSG:4326"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dx =</span> <span class="fl">0.1</span>, </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dy =</span> <span class="fl">0.1</span>, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">dt =</span> <span class="st">"P30D"</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">aggregation =</span> <span class="st">"mean"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">resampling =</span> <span class="st">"near"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dir.create("files"): 'files' already exists</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dir.create("target")</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># mc_alias_set("efi", "data.ecoforecast.org", access_key = "", secret_key = "")</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mc_cp("efi/spat4cast-targets/duration=P1M/variable=lai_recovery/site=august_complex/lai_recovery-target-2025-04-01.tif", "target")</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>parametric_forecast_dir1 <span class="ot">&lt;-</span> <span class="fu">spat_arima_grid</span>(<span class="at">cuberast =</span> raster_cube,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">dir =</span> <span class="st">'gsarima'</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">target  =</span> target_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is likely that grid cells that are close to each other exhibit spatial autocorrelation, and thus it is foolish to throw away that valuable information by treating each grid cell as independent. However, this model is meant to be a simple baseline comparator that demonstrates how parametric forecasts are scored. Baseline models that are currently in development seek to account for this spatial and temporal autocorrelation in a statistically rigorous manner.</p>
<p>Does this forecast seem reasonable?</p>
</section>
</section>
<section id="how-to-submit-a-forecast-to-the-neon-forecast-challenge" class="level2">
<h2 class="anchored" data-anchor-id="how-to-submit-a-forecast-to-the-neon-forecast-challenge">3.6 How to submit a forecast to the NEON Forecast Challenge</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install_mc</span>()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mc_alias_set</span>(<span class="st">"efi"</span>, <span class="st">"data.ecoforecast.org"</span>, <span class="at">access_key =</span> <span class="st">""</span>, <span class="at">secret_key =</span> <span class="st">""</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>ensemble_forecast_dir <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spat4cast_submit</span>(<span class="at">model_id =</span> <span class="st">'johnsemble'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>parametric_forecast_dir1 <span class="sc">|&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spat4cast_submit</span>(<span class="at">model_id =</span> <span class="st">'parametsmith'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluating-your-forecast" class="level1">
<h1>4 Evaluating your forecast</h1>
<section id="how-your-submission-will-be-scored" class="level2">
<h2 class="anchored" data-anchor-id="how-your-submission-will-be-scored">4.1 How your submission will be scored</h2>
<p>Submissions are scored using two different proper scoring rules (Gneiting and Raftery, 2007): the Continuous Ranked Probability Score (CRPS; Matheson and Winkler, 1976) and the Logarithmic Score (LogS; Good, 1952). These scores are defined as follows: given a probability density function <span class="math inline">\(f(\cdot)\)</span> and corresponding cumulative distribution function <span class="math inline">\(F(\cdot)\)</span> for our forecast, and an observation <span class="math inline">\(y\)</span>, the IGN and CRPS may be written: <span class="math display">\[\begin{align}
\text{LogS}(y) &amp;= -\log(f(y));  \\
\text{CRPS}(y) &amp;= \int_{\mathbb{R}} (F(z) - \mathbf{I}_{z \geq y} )^2 dz
\end{align}\]</span> The LogS and CRPS are computed for each grid cell in the target. The individual values for each grid cell are saved, and are useful for visualizing particular areas where the forecast model is performing well or poorly. The final value reported for the challenge is simply the mean value of the respective scores across all grid cells.</p>
<p>There are two broad categories of “types” of forecasts that can be submitted for scoring, and our examples so far have been demonstrative of the differences.</p>
<ul>
<li><em>Ensemble forecasts</em></li>
<li><em>Parametric forecasts</em></li>
</ul>
<p>These forecasts are handled slightly differently in terms of how they are scored. Unsurprisingly, ensemble forecast submissions are scored using the <code>scoring_spat_ensemble</code> function and parametric forecasts are scored using the <code>scoring_spat_parametric</code> function. We will walk through how these two types of forecasts differ, how they are distinguished from one another during submission, and how they are scored.</p>
<p><strong>Parametric forecasts</strong> are forecast distributions that can be described by a probability distribution with a finite set of parameters. For example, a Gaussian forecast distribution with a specified mean and standard deviation would be a parametric forecast. In the context of our spatio-temporal forecasting challenge, this can come across in a few different ways. For example, we may have parametric forecast distributions for each individual grid cell (such as our example auto SARIMA forecasts), or a multivariate distribution that jointly describes the grid such as a Multivariate Normal distribution. When deciding what method to use to score challenge submissions, we search the name of the submission raster for any of the following words:</p>
<ul>
<li>lognormal</li>
<li>normal</li>
<li>bernoulli</li>
<li>beta</li>
<li>uniform</li>
<li>gamma</li>
<li>logistic</li>
<li>exponential</li>
<li>poisson</li>
</ul>
<p>If any of these words are present in the file naming convention for a particular forecast, the scoring pipeline will pull these files out and use the named probability distribution to analytically compute values for the CRPS and LogS.</p>
<p>For two parameter distributions, parametric forecasts submissions can be submitted as one or two GeoTiff files. If two .tifs are being submitted, the names of the file should be “{distribution}_{parameter}_forecast.tif”. The whole file name should be lowercase, but the layers within each .tif do not need to be named.</p>
<p>If a single .tif is being submitted, the file name should be “{distribution}_forecast.tif”, and the layer names must correspond with the appropriate parameter.</p>
<p>For parametric distributions which require only one parameter (poisson, exponential, bernoulli), either naming scheme may be used.</p>
<p><strong>Ensemble forecasts</strong>, like the local climatology baseline model from Section 3.5.1, provide numerous different individual forecasts. These “different” forecasts could all be output from various models, the same model under different parameter settings, or the same model with the same parameters but with some instrinsic randomness or stochasticity. The way that these ensemble members are handled during scoring is fundamentally different than how parametric forecasts are handled. Submitting an ensemble forecast as a user is actually quite easy: create a collection of GeoTiff files, store them in a directory, and use the <code>spat4cast_submit</code> function like we did in Section 3.6. Since each individual ensemble member may be from a different forecast model, we cannot assume that the collection of ensembles comes from some underlying parametric distribution. Instead the ensemble output from each grid cell at each time is used to create probability density function, much like the example from Section 3.5.1! We then use this collection of probability density functions to assign CRPS and LogS scores using the <code>scoringRules</code> package under the hood.</p>
</section>
<section id="how-to-score-your-own-forecast" class="level2">
<h2 class="anchored" data-anchor-id="how-to-score-your-own-forecast">4.2 How to score your own forecast</h2>
<ul>
<li>Which model(s) did best?</li>
<li>What might explain the differences in scores between the different models?</li>
</ul>
</section>
<section id="improving-your-forecasts-incorporating-additional-data" class="level2">
<h2 class="anchored" data-anchor-id="improving-your-forecasts-incorporating-additional-data">4.3 Improving your forecasts: Incorporating additional data</h2>
<p>An obvious choice for improving on the baseline models presented here is to incorporate covariate information into our forecasts of LAI. Three of our focal fires occurred at NEON sites. This means that we have access to a wealth of covariate information, if we are able to access it and process it! In this section, we provide example code that uses the <code>neonstore</code> package to pull and aggregate NEON data for:</p>
<ul>
<li>Temperature (daily minimum and maximum temperature)</li>
<li>Incoming shortwave radiation (daily)</li>
<li>Relative humidity (daily)</li>
</ul>
<p>In order to avoid any potential package and dependecy related issues with the installation of <code>neonstore</code>, we provide all of the example data from this section in a <code>.csv</code> file format on the bucket, so that participants can immediately jump into model building. This process can be roughly broken down into four steps:</p>
<ul>
<li>Identifying your site of interest</li>
<li>Finding and accessing a data product for your covariate of interest</li>
<li>Aggregating data to the desired time scale</li>
<li>(Optional) Imputing missing data</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## set site to desired NEON site</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="do">## here we will use SOAP, but the other focal</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="do">## sites can be used (GRSM or SRER)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="st">'SOAP'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second step is to find a data product that contains your covariate of interest. While these seems like it may be a daunting task, thanks to NEON’s wonderful data portal (found <a href="https://data.neonscience.org/">here</a>) it is not difficult at all. Searching “air temperature” in the data portal search bar gives us multiple options: we will go with Triple Aspirated Air Temperature (<code>DP1.00003.001</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## air temp data product</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>air_temp_dp <span class="ot">&lt;-</span> <span class="st">'DP1.00003.001'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we have identified our site and data product of interest, we can use the <code>neon_download</code> function from the <code>neonstore</code> package to pull the data. For further reading on <code>neonstore</code>, Claire K. Lunch has an excellent tutorial that can be found <a href="https://www.neonscience.org/resources/learning-hub/tutorials/neonstore-stackfromstore-tutorial">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## use neonstore package "neon_download" function to pull data product</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="do">## for triple aspirated air temperature</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">neon_download</span>(<span class="at">product =</span> air_temp_dp, <span class="at">site =</span> site)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With our data product of interest downloaded, we can now focus on aggregation to our desired timescale. Triple aspirated air temperature is available as one and thirty minute averages, and here we demonstrate how to aggregate to daily minimum and maximum temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read the 30 minute measurements into temp_table</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>temp_table <span class="ot">&lt;-</span> <span class="fu">neon_read</span>(<span class="st">"TAAT_30min-basic"</span>, <span class="at">site =</span> site)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="do">## create table of minimum and maximum temps</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>temp_info <span class="ot">&lt;-</span> temp_table <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## use lubridate to extract date format</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extract only max and min data that does not</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## have a quality flag </span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as_date</span>(endDateTime),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">tempTripleMaximum =</span> <span class="fu">if_else</span>(finalQF <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                              tempTripleMaximum,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">NA</span>),</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">tempTripleMinimum =</span> <span class="fu">if_else</span>(finalQF <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>                              tempTripleMinimum,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="do">## group_by date to get daily mins/maxs</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## compute minimums and maximums</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">MinT_daily =</span> <span class="fu">min</span>(tempTripleMinimum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">MaxT_daily =</span> <span class="fu">max</span>(tempTripleMaximum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## change infinite values to NAs for interpolation</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, <span class="sc">~</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>              <span class="fu">replace</span>(., <span class="fu">is.infinite</span>(.), <span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The optional fourth step is imputation of missing data. In this example, we provide code for data imputation using a Kalman filter. We do note that data imputation can be done in many different ways, and thus in the example covariate data provided we include columns with both aggregated imputed data and aggregated raw data for any user who would like to employ their own imputation strategies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(imputeTS) <span class="do">## for na_kalman</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="do">## interpolate missing temperature values using a kalman filter</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>temp_info<span class="sc">$</span>MinTInterp <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(temp_info<span class="sc">$</span>MinT_daily)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>temp_info<span class="sc">$</span>MaxTInterp <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(temp_info<span class="sc">$</span>MaxT_daily)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Though we won’t go through them in detail, additional code for pulling and aggregating shortwave radiation and relative humidity data is below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## set data product for shortwave radiation (primary pyranometer)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>swpp_dp <span class="ot">&lt;-</span> <span class="st">'DP1.00014.001'</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="do">## download shortwave radiation data from NEON</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">neon_download</span>(<span class="at">product =</span> swpp_dp, <span class="at">site =</span> site)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="do">## extract 30 minute shortwave radiation data</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>rad_table <span class="ot">&lt;-</span> <span class="fu">neon_read</span>(<span class="st">"SRDDP_30min-basic"</span>, <span class="at">site =</span> site)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>rad_info <span class="ot">&lt;-</span> rad_table <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as_date</span>(endDateTime),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">gloRadMean =</span> <span class="fu">if_else</span>(gloRadFinalQF <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                              gloRadMean,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">DirRad =</span> <span class="fu">mean</span>(gloRadMean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, <span class="sc">~</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>              <span class="fu">replace</span>(., <span class="fu">is.nan</span>(.), <span class="cn">NA</span>))</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>rad_info<span class="sc">$</span>DirRadInterp <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(rad_info<span class="sc">$</span>DirRad)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="do">## extract and aggregate radiation data to daily time</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>rh_dp <span class="ot">&lt;-</span> <span class="st">'DP1.00098.001'</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="fu">neon_download</span>(<span class="at">product =</span> rh_dp, <span class="at">site =</span> site)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>rh_table <span class="ot">&lt;-</span> <span class="fu">neon_read</span>(<span class="st">"RH_30min"</span>, <span class="at">site =</span> site)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>rh_info <span class="ot">&lt;-</span> rh_table <span class="sc">%&gt;%</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as_date</span>(endDateTime),</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">rhMean =</span> <span class="fu">if_else</span>(RHFinalQF <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                              RHMean,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">RelHum =</span> <span class="fu">mean</span>(RHMean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.numeric, <span class="sc">~</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>              <span class="fu">replace</span>(., <span class="fu">is.nan</span>(.), <span class="cn">NA</span>))</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>rh_info<span class="sc">$</span>RelHumInterp <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(rh_info<span class="sc">$</span>RelHum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="burn-severity-data" class="level3">
<h3 class="anchored" data-anchor-id="burn-severity-data">Burn Severity Data</h3>
<p>One valuable source of information about wildfire impact is burn severity metrics. The USGS maintains a <a href="https://burnseverity.cr.usgs.gov/products">Burn Severity Portal</a>, which provides comprehensive documentation and access to relevant data products. The soil burn severity dataset discussed here was derived from Sentinel-2 satellite imagery and validated in the field by a U.S. Forest Service Burned Area Emergency Response (BAER) team. It is based on an initial Burned Area Reflectance Classification (BARC) dataset, which is created by analyzing pre- and post-fire Sentinel-2 scenes to generate a differenced Normalized Burn Ratio (dNBR) image. This dNBR image illustrates the variation in burn severity across a fire-affected area, capturing the cumulative effects on both vegetation and soil components of the ecosystem. The preliminary BARC dataset is then evaluated by a BAER team and adjusted as needed based on field observations. These data are produced by the USDA Forest Service’s Geospatial Technology and Applications Center (GTAC) to support BAER teams in post-fire assessment and response.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://burnseverity.cr.usgs.gov/sites/burn_severity/files/2025-02/BAER-Method_20250218.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Burn Severity</figcaption>
</figure>
</div>
<p>We have uploaded burn severity maps to the <code>spat4cast_data</code> bucket. These data can be gathered by using the <code>spat4cast_get_data()</code>function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>rastSbs <span class="ot">&lt;-</span> <span class="fu">spat4cast_get_data</span>(<span class="at">fire =</span> <span class="st">"august_complex"</span>,</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">variable =</span> <span class="st">"burn_severity"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in dir.create("files"): 'files' already exists</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rastSbs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="efi_2025_workshop_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
<section id="whats-next" class="level1">
<h1>5 What’s next?</h1>
<ul>
<li>The forecasts we created here were relatively simple. What are ideas you have to improve the forecasts?</li>
<li>How could you expand on this forecasting exercise? More fires? Different forecast horizons?</li>
<li>How could you apply what you have learned here in your research or teaching?</li>
</ul>
<p>Please take the time to provide feedback on the workshop and what you are interested in regarding the post fire recovery challenge as we move towards the official launch of the challenge. <a href="https://docs.google.com/forms/d/e/1FAIpQLSfZ-NtxKjySj6gTnO-6mdfXCZAzQPZPQYoKiVm6S2-EkJ2iMA/viewform?usp=dialog">Spatial Workshop Survey</a></p>
</section>
<section id="acknowledgements" class="level1">
<h1>6 Acknowledgements</h1>
<p>We would like to thank everyone who has joined the EFI Cyberinfrastructure calls during the last two years to provide feedback and discuss progress on this project. A special thank you to Carl Boettiger and Quinn Thomas for all of their assistance, from the onset of this project during the 2023 EFI Unconference to present.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>